#!/usr/bin/env python3
"""
Comprehensive encoding fix script for Bulgarian Cyrillic text.
Fixes mojibake in HTML files using a comprehensive mapping dictionary.
"""

import os
import re
from pathlib import Path

# Comprehensive mapping of garbled to correct Bulgarian text
CORRECTIONS = {
    # Complete phrases (longer phrases first for better matching)
    "РџСЊР»на РіР°СЂР°РЅС†иСЏ на РїСЂРѕиР·веРґеРЅотРѕ": "Пълна гаранция на произведеното",
    "Р"Р°СЂР°РЅС†иРѕРЅРЅРѕ и сР»еРґРіР°СЂР°РЅС†иРѕРЅРЅРѕ С‚еС…РЅиС‡есРєРѕ РѕР±сР»СѓР¶вР°РЅе": "Гаранционно и следгаранционно техническо обслужване",
    "Р'сиС‡Рєи наС€и РјР°С€иРЅи се досС‚Р°вСЏС‚ с:": "Всички наши машини се доставят с:",
    "Р"РѕсС‚Р°вРєР° на СЂезервни С‡Р°сС‚и": "Доставка на резервни части",
    "РћР±СѓС‡еРЅие на РїеСЂсРѕнаР»Р° за СЂР°Р±отР° с РјР°С€инаС‚Р°": "Обучение на персонала за работа с машината",
    "РќР°С€иС‚е услуги вРєР»СЋС‡вР°С‚:": "Нашите услуги включват:",
    "Напишете вР°С€РµС‚Рѕ сСЊРѕР±С‰РµРЅиРµ тук...": "Напишете вашето съобщение тук...",
    "Снимки на наС€иС‚е РјР°С€иРЅи и РїСЂРѕиР·воРґсС‚вРѕ": "Снимки на нашите машини и производство",
    "Р'иРґеРѕ демонстрации на наС€иС‚е РјР°С€иРЅи в действие": "Видео демонстрации на нашите машини в действие",
    "Р'иР¶С‚е наС€иС‚е кантослепващи РјР°С€иРЅи в действие.": "Вижте нашите кантослепващи машини в действие.",
    "Свържете се с нас за РґеРјРѕРЅсС‚СЂР°С†иСЏ или посеС‚еС‚е наС€иСЏ РїСЂРѕиР·воРґсС‚веРЅ С†еС… в гр. Русе.": "Свържете се с нас за демонстрация или посетете нашия производствен цех в гр. Русе.",
    "Машините се РїСЂРѕиР·веР¶даС‚ по РїРѕСЂСЊС‡РєР° споСЂеРґ РЅСѓР¶РґиС‚е на всеки РєР»иент.": "Машините се произвеждат по поръчка според нуждите на всеки клиент.",
    "Свържете се с нас за иРЅРґивиРґСѓР°Р»на РѕС„еСЂС‚Р° и РєРѕРЅсСѓР»С‚Р°С†иСЏ.": "Свържете се с нас за индивидуална оферта и консултация.",
    "Р'СЉР·РјРѕР¶РЅРѕсС‚ за РјРѕРЅС‚иСЂР°РЅе на СЂР°Р·Р»иС‡РЅи Р°РіСЂеРіР°С‚и": "Възможност за монтиране на различни агрегати",
    "РџРѕдавР°С‚еР»еРЅ апарат по Р¶еР»Р°РЅие на РєР»иентР°": "Подавателен апарат по желание на клиента",
    "Р'сиС‡Рєи РїСЂР°вР° Р·Р°РїР°зени.": "Всички права запазени.",
    "Р'сички РїСЂР°вР° Р·Р°РїР°зени.": "Всички права запазени.",
    "РљРњ 7000 - С„СЂеР·РѕвР° отгоре и отдоР»Сѓ, заРѕР±Р»СЏ СЂСЉР±РѕвеС‚е отРїСЂеРґ и отзаРґ, С€РєСѓСЂРєи": "КМ 7000 - фрезова отгоре и отдолу, заобля ръбовете отпред и отзад, шкурки",
    
    # Page titles and headers
    "РћРїисР°РЅие": "Описание",
    "РћРїисание": "Описание",
    "РўеС…РЅиС‡есРєи С…Р°СЂР°РєС‚еСЂисС‚иРєи:": "Технически характеристики:",
    "РўеС…РЅиС‡есРєи С…Р°СЂР°РєС‚еСЂисС‚иРєи": "Технически характеристики",
    "Р"РѕРїСЏР»РЅиС‚еР»на иРЅформаС†иСЏ": "Допълнителна информация",
    "Р"РѕРїСЊР»РЅиС‚еР»на иРЅформация": "Допълнителна информация",
    "Р"РѕРїСЊР»РЅиС‚еР»на иРЅформаС†иСЏ": "Допълнителна информация",
    "Р"Р°СЂР°РЅС†иСЏ и РїРѕддръжка": "Гаранция и поддръжка",
    "Р"Р°СЂР°РЅС†иСЏ и поддръжка": "Гаранция и поддръжка",
    "Р"еРјРѕРЅсС‚СЂР°С†иРѕРЅРЅи виРґеР°:": "Демонстрационни видеа:",
    
    # Individual words and short phrases
    "РРЅРґивиРґСѓР°Р»на РєРѕРЅС„иРіСѓСЂР°С†иСЏ": "Индивидуална конфигурация",
    "Р'исРѕРєР° РїСЂРѕиР·воРґиС‚еР»РЅРѕсС‚": "Висока производителност",
    "РќР°РґеР¶Рґна РєРѕРЅсС‚СЂСѓРєС†иСЏ": "Надеждна конструкция",
    "РџРѕСЂСЉС‡Р°Р№ сеРіР°": "Поръчай сега",
    "РћР±Р°Рґи се": "Обади се",
    "РџСЂеРґиС€на": "Предишна",
    "РЎР»еРґвР°С‰Р°": "Следваща",
    "Р'СЉСЂРЅеС‚е се РіРѕСЂе": "Върнете се горе",
    "ЗаР±еР»еР¶РєР°:": "Забележка:",
    "Р'Р°С€РµС‚Рѕ име": "Вашето име",
    "Р'Р°С€иСЏС‚ e-mail": "Вашият e-mail",
    "Р'Р°С€иСЏС‚ телефон": "Вашият телефон",
    "Р'Р°С€иСЏС‚ вСЊРїСЂРѕс/РїРѕСЂСЊС‡РєР°": "Вашият въпрос/поръчка",
    "Р'Р°С€иСЏС‚ вСЊРїСЂРѕс/поръчка": "Вашият въпрос/поръчка",
    
    # Common single words
    "Р'сиС‡Рєи": "Всички",
    "Р'сички": "Всички",
    "наС€и": "наши",
    "наС€иС‚е": "нашите",
    "наС€иСЏ": "нашия",
    "РјР°С€иРЅи": "машини",
    "РјР°С€инаС‚Р°": "машината",
    "РњР°С€ините": "Машините",
    "досС‚Р°вСЏС‚": "доставят",
    "РїСЂРѕиР·веРґеРЅотРѕ": "произведеното",
    "РїСЂРѕиР·воРґсС‚вРѕ": "производство",
    "РїСЂРѕиР·воРґсС‚веРЅ": "производствен",
    "РїСЂРѕиР·веР¶даС‚": "произвеждат",
    "РїеСЂсРѕнаР»Р°": "персонала",
    "С‚еС…РЅиС‡есРєРѕ": "техническо",
    "РѕР±сР»СѓР¶вР°РЅе": "обслужване",
    "РїСЂР°вР°": "права",
    "СЂР°Р±отР°": "работа",
    "РіР°СЂР°РЅС†иСЏ": "гаранция",
    "РїРѕддръжка": "поддръжка",
    "сР»еРґРіР°СЂР°РЅС†иРѕРЅРЅРѕ": "следгаранционно",
    "СЂезервни": "резервни",
    "С‡Р°сС‚и": "части",
    "Р·Р°РїР°зени": "запазени",
    "РїРѕСЂСЊС‡РєР°": "поръчка",
    "споСЂеРґ": "според",
    "РЅСѓР¶РґиС‚е": "нуждите",
    "РєР»иент": "клиент",
    "РєР»иентР°": "клиента",
    "сеРіР°": "сега",
    "РіРѕСЂе": "горе",
    "иРЅформаС†иСЏ": "информация",
    "иРЅформация": "информация",
    "иРЅРґивиРґСѓР°Р»на": "индивидуална",
    "РѕС„еСЂС‚Р°": "оферта",
    "РєРѕРЅсСѓР»С‚Р°С†иСЏ": "консултация",
    "РјРѕРЅС‚иСЂР°РЅе": "монтиране",
    "СЂР°Р·Р»иС‡РЅи": "различни",
    "Р°РіСЂеРіР°С‚и": "агрегати",
    "Р¶еР»Р°РЅие": "желание",
    "вР°С€РµС‚Рѕ": "вашето",
    "вР°С€иСЏС‚": "вашият",
    "сСЊРѕР±С‰РµРЅиРµ": "съобщение",
    "вСЊРїСЂРѕс": "въпрос",
    "РґеРјРѕРЅсС‚СЂР°С†иСЏ": "демонстрация",
    "РґеРјРѕРЅсС‚СЂР°С†иРѕРЅРЅи": "демонстрационни",
    "виРґеР°": "видеа",
    "виРґеРѕ": "видео",
    "Р'иРґеРѕ": "Видео",
    "посеС‚еС‚е": "посетете",
    "С†еС…": "цех",
    "РїСЉР»на": "пълна",
    "РїСЊР»на": "пълна",
    "РџСЊР»на": "Пълна",
    "РџСЉР»на": "Пълна",
    "РўеС…РЅиС‡есРєи": "Технически",
    "С…Р°СЂР°РєС‚еСЂисС‚иРєи": "характеристики",
    "Р'СЉР·РјРѕР¶РЅРѕсС‚": "Възможност",
    "РџРѕдавР°С‚еР»еРЅ": "Подавателен",
    "РРЅРґивиРґСѓР°Р»на": "Индивидуална",
    "РєРѕРЅС„иРіСѓСЂР°С†иСЏ": "конфигурация",
    "РїСЂРѕиР·воРґиС‚еР»РЅРѕсС‚": "производителност",
    "РєРѕРЅсС‚СЂСѓРєС†иСЏ": "конструкция",
    "РџРѕСЂСЉС‡Р°Р№": "Поръчай",
    "РћР±Р°Рґи": "Обади",
    "Р"РѕРїСЊР»РЅиС‚еР»на": "Допълнителна",
    "ЗаР±еР»еР¶РєР°": "Забележка",
    "Р"Р°СЂР°РЅС†иСЏ": "Гаранция",
    "РћР±СѓС‡еРЅие": "Обучение",
    "Р"Р°СЂР°РЅС†иРѕРЅРЅРѕ": "Гаранционно",
    "Р"РѕсС‚Р°вРєР°": "Доставка",
    "Р'СЊСЂРЅеС‚е": "Върнете",
    "Р'Р°С€РµС‚Рѕ": "Вашето",
    "Р'Р°С€иСЏС‚": "Вашият",
    "Напишете": "Напишете",
    "Снимки": "Снимки",
    "Р'иР¶С‚е": "Вижте",
    "Свържете": "Свържете",
    "РіСЂ.": "гр.",
    "Р'исРѕРєР°": "Висока",
    "РќР°РґеР¶Рґна": "Надеждна",
    "С„СЂеР·РѕвР°": "фрезова",
    "отдоР»Сѓ": "отдолу",
    "заРѕР±Р»СЏ": "заобля",
    "СЂСЉР±РѕвеС‚е": "ръбовете",
    "отРїСЂеРґ": "отпред",
    "отзаРґ": "отзад",
    "С€РєСѓСЂРєи": "шкурки",
}

def fix_file(filepath):
    """Fix encoding in a single HTML file."""
    print(f"Processing: {filepath}")
    
    # Read the file removing BOM
    with open(filepath, 'r', encoding='utf-8-sig') as f:
        content = f.read()
    
    original_content = content
    
    # Apply corrections - sort by length (longest first) to avoid partial replacements
    sorted_corrections = sorted(CORRECTIONS.items(), key=lambda x: len(x[0]), reverse=True)
    
    changes_made = 0
    for garbled, correct in sorted_corrections:
        if garbled in content:
            count = content.count(garbled)
            content = content.replace(garbled, correct)
            changes_made += count
            if count > 0:
                print(f"  Fixed {count}x: {garbled[:40]}... -> {correct[:40]}...")
    
    # Write back without BOM
    if content != original_content:
        with open(filepath, 'w', encoding='utf-8', newline='\n') as f:
            f.write(content)
        print(f"  ✓ Completed: {filepath} ({changes_made} changes)")
    else:
        print(f"  ✓ No changes needed: {filepath}")

def main():
    """Fix all HTML files in the repository."""
    base_dir = Path('/home/runner/work/solidnost/solidnost')
    
    # List of HTML files to fix (excluding original.html which is the reference)
    html_files = [
        'index.html',
        'products/product-km7000.html',
        'products/product-km2015tpm.html',
        'products/product-km4001pe.html',
        'products/product-km900m.html',
        'pages/servizni-uslugi.html',
        'pages/vtora-upotreba.html',
        'pages/kantoslepvashti-mashini.html',
        'pages/video-galeria.html',
        'pages/kontakti.html',
        'pages/galeria.html',
        'favicon-generator.html',
    ]
    
    for html_file in html_files:
        filepath = base_dir / html_file
        if filepath.exists():
            fix_file(str(filepath))
        else:
            print(f"Warning: File not found: {filepath}")
    
    print("\n✓ All files processed!")

if __name__ == '__main__':
    main()
